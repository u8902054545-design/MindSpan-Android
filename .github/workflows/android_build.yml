name: Android Build

on:
  push:
    branches: [ master, main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Build APK
        run: |
          # Устанавливаем переменные путей
          SDK_JAR="${ANDROID_HOME}/platforms/android-34/android.jar"
          # Находим путь к build-tools (берем последнюю версию)
          BUILD_TOOLS=$(ls -d ${ANDROID_HOME}/build-tools/* | tail -1)
          PATH=$PATH:$BUILD_TOOLS
          
          mkdir -p build/gen build/obj build/bin
          
          echo "Using build-tools from: $BUILD_TOOLS"
          
          echo "Processing resources..."
          aapt package -f -m -J build/gen -S app/src/main/res -M app/src/main/AndroidManifest.xml -I $SDK_JAR
          
          echo "Compiling Java..."
          javac -d build/obj -source 1.8 -target 1.8 -cp $SDK_JAR \
            build/gen/com/mindspan/app/R.java \
            app/src/main/java/com/mindspan/app/MainActivity.java
          
          echo "Converting to DEX..."
          # Используем d8 из build-tools
          d8 --output build/bin/ --lib $SDK_JAR build/obj/com/mindspan/app/*.class
          
          echo "Packaging APK..."
          aapt package -f -M app/src/main/AndroidManifest.xml -S app/src/main/res -A app/src/main/assets -I $SDK_JAR -F MindSpan-debug.apk build/bin/

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: MindSpan-App
          path: MindSpan-debug.apk
